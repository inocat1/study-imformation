<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ‹æ–‡å½¢éŸ³ç¾©ç‰¹è¨“</title>
    <style>
        :root {
            --primary: #c2410c;       /* æœ±ç ‚ç´… */
            --primary-light: #ffedd5; 
            --bg-gradient-1: #fff7ed;
            --bg-gradient-2: #fed7aa;
            --text: #431407;
            --success: #15803d;
            --error: #b91c1c;
            --info: #1d4ed8;
        }

        body {
            font-family: "KaiTi", "BiauKai", "DFKai-SB", serif;
            background: linear-gradient(135deg, var(--bg-gradient-1) 0%, var(--bg-gradient-2) 100%);
            color: var(--text);
            margin: 0; padding: 20px;
            min-height: 100vh; display: flex; justify-content: center; align-items: center;
        }

        .container {
            width: 100%; max-width: 650px;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 24px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            overflow: hidden; position: relative;
            min-height: 600px; display: flex; flex-direction: column;
            border: 2px solid #fdba74;
        }

        header {
            padding: 15px 20px; text-align: center; border-bottom: 2px solid #fdba74;
            background: #fffaf0; position: relative;
        }
        h1 { margin: 0; font-size: 1.6rem; letter-spacing: 2px; }
        
        .exit-btn {
            position: absolute; right: 15px; top: 15px;
            background: #fecaca; border: 1px solid #ef4444; color: #b91c1c;
            padding: 5px 12px; border-radius: 15px; cursor: pointer; font-weight: bold;
            font-size: 0.9rem; display: none; /* é è¨­éš±è— */
        }
        .exit-btn:hover { background: #fee2e2; }

        .view-section { padding: 20px; flex: 1; display: flex; flex-direction: column; }
        
        /* é¸å–®æ¨£å¼ */
        .settings-panel {
            background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 20px;
            border: 1px solid #fed7aa;
        }
        .label { font-weight: bold; margin-bottom: 8px; display: block; font-size: 1.1rem; }
        .num-input {
            width: 100%; padding: 10px; font-size: 1.2rem; text-align: center;
            border: 2px solid #fdba74; border-radius: 8px; box-sizing: border-box;
            font-family: inherit; font-weight: bold; color: var(--primary);
        }

        .chapter-grid { display: grid; grid-template-columns: 1fr; gap: 10px; max-height: 300px; overflow-y: auto; }
        .chapter-card {
            background: #fff; border: 2px solid #fed7aa; padding: 12px; border-radius: 10px;
            cursor: pointer; transition: 0.2s; display: flex; align-items: center;
            font-weight: bold; font-size: 1.1rem;
        }
        .chapter-card:hover { background: #fff7ed; }
        .chapter-card.selected {
            background: var(--primary-light); border-color: var(--primary); color: var(--primary);
        }
        .chapter-card::before {
            content: "â˜"; margin-right: 10px; font-size: 1.3rem;
        }
        .chapter-card.selected::before {
            content: "â˜‘";
        }

        .action-btn {
            margin-top: auto; width: 100%; padding: 15px; border: none; border-radius: 50px;
            background: var(--primary); color: white; font-size: 1.2rem; font-weight: bold;
            cursor: pointer; transition: 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .action-btn:disabled { background: #cbd5e1; cursor: not-allowed; box-shadow: none; }
        .action-btn.secondary { background: #fff; color: var(--primary); border: 2px solid var(--primary); margin-bottom: 10px;}

        /* æ¸¬é©—æ¨£å¼ */
        .progress-bar { height: 8px; background: #e2e8f0; border-radius: 4px; margin-bottom: 20px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: 0.3s; }

        .quiz-card {
            background: #fff; padding: 30px 20px; border-radius: 20px; text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid #fed7aa;
        }
        .q-text { font-size: 2.2rem; font-weight: 800; color: #333; }
        
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;}
        .opt-btn {
            padding: 15px; border: 2px solid #fdba74; border-radius: 12px; background: white;
            font-size: 1.8rem; cursor: pointer; transition: 0.1s; font-family: inherit; font-weight: bold;
        }
        .opt-btn:hover { background: #fff7ed; transform: translateY(-2px); }
        .opt-btn.correct { background: #dcfce7; border-color: var(--success); color: #065f46; }
        .opt-btn.wrong { background: #fee2e2; border-color: var(--error); color: #991b1b; }
        .opt-btn:disabled { cursor: default; transform: none; }

        /* è§£æå€å¡Š */
        .explanation-box {
            background: #f0f9ff; border: 2px solid #bae6fd; border-radius: 12px;
            padding: 15px; margin-top: 10px; display: none; text-align: left;
            animation: fadeIn 0.3s;
        }
        .exp-title { color: #0369a1; font-weight: bold; margin-bottom: 5px; font-size: 1.1rem; }
        .exp-text { margin-bottom: 8px; line-height: 1.5; color: #334155; }
        .exp-tag { display: inline-block; background: #e0f2fe; color: #0284c7; padding: 2px 8px; border-radius: 4px; font-size: 0.9rem; font-weight: bold; margin-right: 5px;}
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* çµæœé  */
        .score-display { font-size: 5rem; font-weight: 800; color: var(--primary); margin: 20px 0; }
        .mistake-item { 
            text-align: left; padding: 15px; border-bottom: 1px dashed #fdba74; 
            font-size: 1.1rem;
        }
        .correct-char { color: var(--success); font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>åœ‹æ–‡å½¢éŸ³ç¾©ç‰¹è¨“</h1>
        <button id="btn-exit" class="exit-btn" onclick="quitQuiz()">çµæŸæ¸¬é©—</button>
    </header>

    <!-- 1. é¸å–®èˆ‡è¨­å®š -->
    <div id="view-menu" class="view-section">
        
        <div class="settings-panel">
            <span class="label">1. è¨­å®šé¡Œæ•¸ (è¼¸å…¥ 0 ç‚ºå…¨éƒ¨é¡Œç›®)</span>
            <input type="number" id="q-count-input" class="num-input" value="10" min="0">
        </div>

        <div class="settings-panel" style="flex:1; display:flex; flex-direction:column;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <span class="label" style="margin:0;">2. é¸æ“‡ç« ç¯€ (å¯å¤šé¸æ··æ­)</span>
                <button onclick="selectAllChapters()" style="background:none; border:none; color:var(--primary); font-weight:bold; cursor:pointer; text-decoration:underline;">å…¨é¸/å…¨å–æ¶ˆ</button>
            </div>
            <div id="chapter-list" class="chapter-grid"></div>
        </div>

        <button id="btn-start" class="action-btn" onclick="startQuiz()" disabled>é–‹å§‹æ¸¬é©—</button>
    </div>

    <!-- 2. æ¸¬é©—ä¸­ -->
    <div id="view-quiz" class="view-section" style="display:none;">
        <div style="display:flex; justify-content:space-between; font-weight:bold; margin-bottom:10px;">
            <span id="q-progress">1 / 10</span>
            <span id="q-score">å¾—åˆ†: 0</span>
        </div>
        <div class="progress-bar"><div id="bar-fill" class="progress-fill"></div></div>

        <div class="quiz-card">
            <div id="q-word" class="q-text">é¡Œç›®...</div>
        </div>

        <div id="options-area" class="options-grid"></div>

        <!-- è§£æå€å¡Š -->
        <div id="explanation-area" class="explanation-box">
            <div class="exp-title">ğŸ“ è§£æ</div>
            <div id="exp-meaning" class="exp-text"></div>
            <div id="exp-char" class="exp-text"></div>
            <div id="exp-source" class="exp-text"></div>
        </div>

        <button id="btn-next" class="action-btn" style="display:none; margin-top:15px;" onclick="nextQuestion()">ä¸‹ä¸€é¡Œ â”</button>
    </div>

    <!-- 3. çµæœ -->
    <div id="view-result" class="view-section" style="display:none; text-align:center;">
        <h2>æ¸¬é©—çµæŸ</h2>
        <div class="score-display" id="final-score">100</div>
        
        <div id="mistake-area" style="margin: 20px 0; max-height: 250px; overflow-y: auto; display:none;">
            <h3 style="color:#b91c1c;">éŒ¯é¡Œè¤‡ç¿’</h3>
            <div id="mistake-list"></div>
        </div>

        <button class="action-btn" onclick="location.reload()">å›é¸å–®</button>
    </div>
</div>

<script src="chinese_data.js"></script>

<script>
    let selectedChapters = new Set();
    let quizList = [];
    let currentIdx = 0;
    let score = 0;
    let mistakes = [];

    window.onload = function() {
        if (typeof chineseData === 'undefined') {
            alert("éŒ¯èª¤ï¼šæ‰¾ä¸åˆ° chinese_data.js");
            return;
        }
        renderMenu();
    };

    function renderMenu() {
        const menu = document.getElementById('chapter-list');
        menu.innerHTML = '';
        Object.keys(chineseData).forEach(round => {
            const btn = document.createElement('div');
            btn.className = 'chapter-card';
            btn.innerText = round;
            btn.onclick = () => toggleChapter(btn, round);
            menu.appendChild(btn);
        });
    }

    function toggleChapter(btn, round) {
        if (selectedChapters.has(round)) {
            selectedChapters.delete(round);
            btn.classList.remove('selected');
        } else {
            selectedChapters.add(round);
            btn.classList.add('selected');
        }
        updateStartBtn();
    }

    function selectAllChapters() {
        const allRounds = Object.keys(chineseData);
        const btns = document.querySelectorAll('.chapter-card');
        
        if (selectedChapters.size === allRounds.length) {
            // å…¨å–æ¶ˆ
            selectedChapters.clear();
            btns.forEach(b => b.classList.remove('selected'));
        } else {
            // å…¨é¸
            allRounds.forEach(r => selectedChapters.add(r));
            btns.forEach(b => b.classList.add('selected'));
        }
        updateStartBtn();
    }

    function updateStartBtn() {
        const btn = document.getElementById('btn-start');
        btn.disabled = selectedChapters.size === 0;
        btn.innerText = selectedChapters.size === 0 ? "è«‹é¸æ“‡ç« ç¯€" : `é–‹å§‹æ¸¬é©— (å·²é¸ ${selectedChapters.size} ç« )`;
    }

    function startQuiz() {
        // 1. æ”¶é›†æ‰€æœ‰é¸ä¸­ç« ç¯€çš„é¡Œç›®
        let pool = [];
        selectedChapters.forEach(round => {
            pool = pool.concat(chineseData[round]);
        });

        if (pool.length === 0) return;

        // 2. è™•ç†é¡Œæ•¸è¨­å®š
        const inputCount = parseInt(document.getElementById('q-count-input').value) || 0;
        const finalCount = (inputCount === 0 || inputCount > pool.length) ? pool.length : inputCount;

        // 3. æ´—ç‰Œä¸¦åˆ‡ç‰‡
        // æ·±æ‹·è²ä»¥é˜²ä¿®æ”¹åˆ°åŸå§‹è³‡æ–™
        let questions = JSON.parse(JSON.stringify(pool));
        shuffle(questions);
        quizList = questions.slice(0, finalCount);

        // 4. åˆå§‹åŒ–é¡Œç›®é¸é … (æ‰“äº‚é¸é …)
        quizList.forEach(q => {
            q.shuffledOptions = shuffle([...q.o]);
            q.shuffledOptions = [...new Set(q.shuffledOptions)];
        });

        // 5. åˆ‡æ›ç•«é¢
        document.getElementById('view-menu').style.display = 'none';
        document.getElementById('view-quiz').style.display = 'block';
        document.getElementById('btn-exit').style.display = 'block'; // é¡¯ç¤ºé€€å‡ºæŒ‰éˆ•
        
        currentIdx = 0;
        score = 0;
        mistakes = [];
        loadQuestion();
    }

    function loadQuestion() {
        // éš±è—è§£æèˆ‡ä¸‹ä¸€é¡ŒæŒ‰éˆ•
        document.getElementById('explanation-area').style.display = 'none';
        document.getElementById('btn-next').style.display = 'none';

        if (currentIdx >= quizList.length) {
            endQuiz();
            return;
        }

        const qData = quizList[currentIdx];
        
        // æ›´æ–°é€²åº¦
        document.getElementById('q-progress').innerText = `${currentIdx + 1} / ${quizList.length}`;
        document.getElementById('q-score').innerText = `å¾—åˆ†: ${Math.round(score)}`;
        document.getElementById('bar-fill').style.width = `${((currentIdx) / quizList.length) * 100}%`;
        
        // é¡¯ç¤ºé¡Œç›®
        document.getElementById('q-word').innerText = qData.q;

        // é¡¯ç¤ºé¸é …
        const optArea = document.getElementById('options-area');
        optArea.innerHTML = ''; 

        qData.shuffledOptions.forEach(optChar => {
            const btn = document.createElement('button');
            btn.className = 'opt-btn';
            btn.innerText = optChar;
            btn.onclick = () => checkAnswer(btn, optChar, qData);
            optArea.appendChild(btn);
        });
    }

    function checkAnswer(btn, userAns, qData) {
        // é–å®šæŒ‰éˆ•
        const allBtns = document.querySelectorAll('.opt-btn');
        allBtns.forEach(b => b.disabled = true);

        let isCorrect = (userAns === qData.a);

        if (isCorrect) {
            btn.classList.add('correct');
            score += (100 / quizList.length);
        } else {
            btn.classList.add('wrong');
            allBtns.forEach(b => {
                if (b.innerText.includes(qData.a)) b.classList.add('correct');
            });
            mistakes.push(qData);
        }

        // é¡¯ç¤ºè§£æ
        showExplanation(qData);
        
        // é¡¯ç¤ºä¸‹ä¸€é¡ŒæŒ‰éˆ• (ä¸è‡ªå‹•è·³è½‰ï¼Œè®“ä½¿ç”¨è€…çœ‹è§£æ)
        document.getElementById('btn-next').style.display = 'block';
        // è‡ªå‹•æ²å‹•åˆ°è§£æå€
        document.getElementById('explanation-area').scrollIntoView({behavior: "smooth", block: "nearest"});
    }
    
    function showExplanation(qData) {
        const expBox = document.getElementById('explanation-area');
        
        // è™•ç†æ²’æœ‰è³‡æ–™çš„æƒ…æ³
        const mean = qData.m ? qData.m : "ï¼ˆç„¡æˆèªé‡‹ç¾©è³‡æ–™ï¼‰";
        const charMean = qData.cm ? qData.cm : "ï¼ˆç„¡å­—ç¾©è³‡æ–™ï¼‰";
        const source = qData.src ? qData.src : "";

        document.getElementById('exp-meaning').innerHTML = `<span class="exp-tag">é‡‹ç¾©</span>${mean}`;
        document.getElementById('exp-char').innerHTML = `<span class="exp-tag">å­—ç¾©</span>${charMean}`;
        
        if (source) {
            document.getElementById('exp-source').innerHTML = `<span class="exp-tag">å¤æ–‡</span>${source}`;
            document.getElementById('exp-source').style.display = 'block';
        } else {
            document.getElementById('exp-source').style.display = 'none';
        }

        expBox.style.display = 'block';
    }

    function nextQuestion() {
        currentIdx++;
        loadQuestion();
        // æ²å‹•å›é ‚éƒ¨
        document.querySelector('.container').scrollIntoView({behavior: "smooth"});
    }

    function quitQuiz() {
        if(confirm("ç¢ºå®šè¦ä¸­é€”çµæŸæ¸¬é©—å—ï¼Ÿ")) {
            endQuiz();
        }
    }

    function endQuiz() {
        document.getElementById('view-quiz').style.display = 'none';
        document.getElementById('btn-exit').style.display = 'none';
        document.getElementById('view-result').style.display = 'block';
        document.getElementById('final-score').innerText = Math.round(score);

        if (mistakes.length > 0) {
            const area = document.getElementById('mistake-area');
            const list = document.getElementById('mistake-list');
            area.style.display = 'block';
            list.innerHTML = '';
            
            mistakes.forEach(m => {
                const div = document.createElement('div');
                div.className = 'mistake-item';
                div.innerHTML = `
                    <div style="font-weight:bold; margin-bottom:5px;">${m.q.replace('ã€Œ ã€', `ã€Œ<span class="correct-char">${m.a}</span>ã€`)}</div>
                    <div style="font-size:0.9rem; color:#666;">${m.m || ''}</div>
                `;
                list.appendChild(div);
            });
        }
    }

    function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }
</script>
</body>
</html>
