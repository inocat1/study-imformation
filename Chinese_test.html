<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>國文全能特訓基地</title>
    <style>
        :root {
            --primary: #c2410c;       /* 主色：朱砂紅 */
            --primary-light: #fff7ed; 
            --active-tab: #9a3412;    /* 深紅色 */
            --bg-gradient-1: #fff7ed;
            --bg-gradient-2: #fed7aa;
            --text: #431407;
            --success: #15803d;
            --error: #b91c1c;
            --gray: #64748b;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            /* 優先使用標楷體，若無則使用明體或預設襯線體 */
            font-family: "KaiTi", "BiauKai", "DFKai-SB", "PMingLiU", serif;
            background: linear-gradient(135deg, var(--bg-gradient-1) 0%, var(--bg-gradient-2) 100%);
            color: var(--text);
            margin: 0; padding: 10px;
            min-height: 100vh; display: flex; justify-content: center; align-items: flex-start;
        }

        .container {
            width: 100%; max-width: 600px;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            overflow: hidden; position: relative;
            min-height: 85vh; display: flex; flex-direction: column;
            border: 2px solid #fdba74;
            margin-top: 5px;
        }

        /* --- Header & Tabs --- */
        header {
            background: #fffaf0; border-bottom: 1px solid #fdba74;
            position: sticky; top: 0; z-index: 10;
        }

        .top-bar {
            display: flex; justify-content: center; align-items: center;
            padding: 15px; position: relative;
        }

        h1 { margin: 0; font-size: 1.4rem; letter-spacing: 2px; font-weight: 800; }

        .exit-btn {
            position: absolute; right: 15px;
            background: #fee2e2; border: 1px solid #ef4444; color: #b91c1c;
            padding: 6px 12px; border-radius: 20px; cursor: pointer; font-weight: bold;
            font-size: 0.85rem; display: none;
        }

        /* 分頁標籤列 */
        .tab-container {
            display: flex; background: #ffedd5;
        }
        .tab-btn {
            flex: 1; text-align: center; padding: 12px 5px; /* 稍微縮小內距以容納三個按鈕 */
            font-size: 1rem; font-weight: bold; color: #7c2d12;
            cursor: pointer; transition: 0.2s; border-bottom: 3px solid transparent;
            opacity: 0.6; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .tab-btn.active {
            background: #fff; color: var(--primary);
            border-bottom: 3px solid var(--primary);
            opacity: 1;
        }

        /* --- 內容區 --- */
        .view-section { 
            padding: 20px; flex: 1; display: flex; flex-direction: column; 
            overflow-y: auto; 
        }
        
        /* --- 1. 章節選擇頁 --- */
        .chapter-grid { display: grid; grid-template-columns: 1fr; gap: 12px; margin-bottom: 20px; }
        .chapter-card {
            background: #fff; border: 2px solid #fdba74; padding: 16px; border-radius: 12px;
            cursor: pointer; transition: 0.2s; display: flex; align-items: center;
            font-weight: bold; font-size: 1.1rem; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .chapter-card:active { transform: scale(0.98); }
        .chapter-card.selected {
            background: #fff7ed; border-color: var(--primary); color: var(--primary);
        }
        .chapter-card::before { content: "☐"; margin-right: 12px; font-size: 1.4rem; }
        .chapter-card.selected::before { content: "☑"; }

        /* --- 2. 題數設定頁 --- */
        .setting-box { text-align: center; margin-top: 20px; }
        .quick-select { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0; }
        .num-btn {
            padding: 15px; border: 2px solid #fdba74; background: white; border-radius: 12px;
            font-size: 1.2rem; font-weight: bold; color: var(--text); cursor: pointer;
        }
        .num-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .custom-input {
            width: 100%; padding: 15px; font-size: 1.2rem; text-align: center;
            border: 2px solid #cbd5e1; border-radius: 12px; margin-top: 10px;
            font-family: inherit; font-weight: bold; color: var(--primary);
        }

        /* --- 3. 測驗介面 --- */
        .progress-bar { height: 6px; background: #e2e8f0; border-radius: 3px; margin-bottom: 25px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: 0.3s; }

        .quiz-card {
            background: #fff; padding: 30px 15px; border-radius: 16px; text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid #fed7aa;
            display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 120px;
        }
        .q-text { font-size: 1.8rem; font-weight: 800; color: #333; line-height: 1.5; }
        
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;}
        .opt-btn {
            padding: 15px; border: 2px solid #fdba74; border-radius: 16px; background: white;
            font-size: 1.3rem; /* 適應較長選項 */
            cursor: pointer; transition: 0.1s; font-family: inherit; font-weight: bold;
            display: flex; justify-content: center; align-items: center; text-align: center;
            min-height: 70px; word-break: break-word; /* 自動換行 */
        }
        .opt-btn:active { background: #fff7ed; transform: scale(0.95); }
        .opt-btn.correct { background: #dcfce7; border-color: var(--success); color: #065f46; }
        .opt-btn.wrong { background: #fee2e2; border-color: var(--error); color: #991b1b; }

        /* --- 解析區 --- */
        .explanation-box {
            background: #f0f9ff; border: 2px solid #bae6fd; border-radius: 12px;
            padding: 15px; margin-top: 15px; display: none; text-align: left;
            animation: slideUp 0.3s;
        }
        @keyframes slideUp { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .exp-row { margin-bottom: 10px; line-height: 1.6; font-size: 1.05rem; }
        .exp-tag { 
            display: inline-block; background: #0ea5e9; color: white; 
            padding: 2px 8px; border-radius: 6px; font-size: 0.85rem; 
            font-weight: bold; margin-right: 6px; vertical-align: text-bottom;
        }

        /* --- 結果頁 --- */
        .score-display { font-size: 5rem; font-weight: 800; color: var(--primary); margin: 20px 0; line-height: 1; }
        .mistake-item { 
            text-align: left; padding: 15px; border-bottom: 1px dashed #fdba74; 
            font-size: 1.1rem; background: #fff; border-radius: 8px; margin-bottom: 8px;
        }
        .correct-char { color: var(--success); font-weight: bold; border-bottom: 2px solid var(--success);}

        /* --- 按鈕 --- */
        .action-btn {
            margin-top: auto; width: 100%; padding: 16px; border: none; border-radius: 30px;
            background: var(--primary); color: white; font-size: 1.2rem; font-weight: bold;
            cursor: pointer; transition: 0.2s; box-shadow: 0 4px 10px rgba(194, 65, 12, 0.3);
            margin-bottom: 10px;
        }
        .action-btn:disabled { background: #cbd5e1; cursor: not-allowed; box-shadow: none; }
        .secondary-btn {
            background: transparent; color: var(--gray); border: none; padding: 10px;
            font-size: 1rem; font-weight: bold; cursor: pointer; text-decoration: underline;
            width: 100%; text-align: center;
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="top-bar">
            <h1 id="page-title">國文全能特訓</h1>
            <button id="btn-exit" class="exit-btn" onclick="quitQuiz()">退出</button>
        </div>
        
        <!-- 分頁切換區 (Tab) -->
        <div class="tab-container" id="tab-bar">
            <div class="tab-btn active" onclick="switchTab('shape')">形音義道場</div>
            <div class="tab-btn" onclick="switchTab('meaning')">一字多義道場</div>
            <div class="tab-btn" onclick="switchTab('idiom')">成語古文道場</div>
        </div>
    </header>

    <!-- 1. 章節選擇頁 -->
    <div id="view-chapters" class="view-section">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <span style="font-weight:bold; color:var(--text); font-size:1.1rem;" id="tab-hint">請選擇章節</span>
            <button onclick="selectAllChapters()" style="background:none; border:none; color:var(--primary); font-weight:bold; cursor:pointer; font-size:1rem;">全選</button>
        </div>
        <div id="chapter-list" class="chapter-grid"></div>
        <button id="btn-to-settings" class="action-btn" onclick="goToSettings()" disabled>下一步</button>
    </div>

    <!-- 2. 題數設定頁 -->
    <div id="view-settings" class="view-section" style="display:none;">
        <div class="setting-box">
            <h2 style="color:var(--text); margin-bottom:5px;">要練習幾題？</h2>
            <p style="color:var(--gray); margin-top:0;">目前範圍共：<span id="total-pool-count">0</span> 題</p>
            
            <div class="quick-select">
                <div class="num-btn" onclick="selectCount(10)">10 題</div>
                <div class="num-btn" onclick="selectCount(20)">20 題</div>
                <div class="num-btn" onclick="selectCount(50)">50 題</div>
                <div class="num-btn active" id="btn-all" onclick="selectCount(0)">全部</div>
            </div>

            <div style="margin-top:20px; text-align:left;">
                <label style="font-weight:bold; color:var(--gray);">或自訂題數：</label>
                <input type="number" id="custom-count" class="custom-input" placeholder="輸入數字..." oninput="clearQuickSelect()">
            </div>
        </div>
        
        <div style="margin-top:auto;">
            <button class="action-btn" onclick="startQuiz()">開始測驗</button>
            <button class="secondary-btn" onclick="backToChapters()">回上一頁</button>
        </div>
    </div>

    <!-- 3. 測驗進行中 -->
    <div id="view-quiz" class="view-section" style="display:none;">
        <div style="display:flex; justify-content:space-between; font-weight:bold; color:var(--gray); margin-bottom:10px; font-size:0.9rem;">
            <span id="q-progress">1 / 10</span>
            <span id="q-score">得分: 0</span>
        </div>
        <div class="progress-bar"><div id="bar-fill" class="progress-fill"></div></div>

        <div class="quiz-card">
            <div id="q-word" class="q-text"></div>
        </div>

        <div id="options-area" class="options-grid"></div>

        <!-- 解析區 -->
        <div id="explanation-area" class="explanation-box">
            <div class="exp-row"><span class="exp-tag">釋義</span><span id="exp-meaning"></span></div>
            <div class="exp-row" id="exp-char-row"><span class="exp-tag">字義</span><span id="exp-char"></span></div>
            <div class="exp-row" id="exp-source-row"><span class="exp-tag" style="background:#7c3aed;">出處</span><span id="exp-source"></span></div>
        </div>

        <button id="btn-next" class="action-btn" style="display:none; margin-top:20px;" onclick="nextQuestion()">下一題 ➔</button>
    </div>

    <!-- 4. 結果頁 -->
    <div id="view-result" class="view-section" style="display:none; text-align:center;">
        <h2 style="color:var(--text);">測驗結束</h2>
        <div class="score-display" id="final-score">100</div>
        <p style="color:var(--gray);">本次得分</p>
        
        <div id="mistake-area" style="margin: 20px 0; flex:1; overflow-y: auto; display:none; border-top: 2px solid #eee; padding-top:10px;">
            <h3 style="color:#b91c1c; text-align:left;">⚠️ 錯題複習</h3>
            <div id="mistake-list"></div>
        </div>

        <button class="action-btn" onclick="location.reload()">回首頁</button>
    </div>
</div>

<!-- 引入資料檔 -->
<script src="chinese_data.js"></script>

<script>
    let currentMode = 'shape'; // 'shape', 'meaning', 'idiom'
    let selectedChapters = new Set();
    let poolSize = 0;
    let selectedCount = 0;
    let quizList = [];
    let currentIdx = 0;
    let score = 0;
    let mistakes = [];

    window.onload = function() {
        if (typeof chineseData === 'undefined') {
            alert("錯誤：找不到 chinese_data.js，請確認檔案已上傳且位於同一資料夾！");
            return;
        }
        renderMenu();
    };

    // --- 1. 分頁切換邏輯 ---
    function switchTab(mode) {
        currentMode = mode;
        // 更新 UI 樣式
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        
        if (mode === 'shape') {
            document.querySelectorAll('.tab-btn')[0].classList.add('active');
        } else if (mode === 'meaning') {
            document.querySelectorAll('.tab-btn')[1].classList.add('active');
        } else {
            document.querySelectorAll('.tab-btn')[2].classList.add('active');
        }
        
        // 清空已選狀態，重新渲染選單
        selectedChapters.clear();
        document.getElementById('btn-to-settings').disabled = true;
        renderMenu();
    }

    // --- 2. 選單渲染 ---
    function renderMenu() {
        const menu = document.getElementById('chapter-list');
        menu.innerHTML = '';
        
        // 根據模式篩選章節 Key
        // 1. 一字多義：包含 "一字多義"
        // 2. 成語古文：包含 "成語" 或 "古今義"
        // 3. 形音義：剩下的都是 (包含 "改錯字", "形近")
        Object.keys(chineseData).forEach(round => {
            let isMeaning = round.includes("一字多義");
            let isIdiom = round.includes("成語") || round.includes("古今義");
            
            let show = false;
            if (currentMode === 'meaning' && isMeaning) show = true;
            else if (currentMode === 'idiom' && isIdiom) show = true;
            else if (currentMode === 'shape' && !isMeaning && !isIdiom) show = true;

            if (show) {
                const btn = document.createElement('div');
                btn.className = 'chapter-card';
                btn.innerText = round;
                btn.onclick = () => toggleChapter(btn, round);
                menu.appendChild(btn);
            }
        });
    }

    function toggleChapter(btn, round) {
        if (selectedChapters.has(round)) {
            selectedChapters.delete(round);
            btn.classList.remove('selected');
        } else {
            selectedChapters.add(round);
            btn.classList.add('selected');
        }
        document.getElementById('btn-to-settings').disabled = selectedChapters.size === 0;
    }

    function selectAllChapters() {
        const menu = document.getElementById('chapter-list');
        const btns = menu.querySelectorAll('.chapter-card');
        
        let allSelected = true;
        if (btns.length === 0) allSelected = false; 
        btns.forEach(btn => {
            if (!btn.classList.contains('selected')) allSelected = false;
        });

        if (allSelected) {
            btns.forEach(b => {
                b.classList.remove('selected');
                selectedChapters.delete(b.innerText);
            });
        } else {
            btns.forEach(b => {
                b.classList.add('selected');
                selectedChapters.add(b.innerText);
            });
        }
        document.getElementById('btn-to-settings').disabled = selectedChapters.size === 0;
    }

    // --- 3. 題數設定與流程 ---
    function goToSettings() {
        poolSize = 0;
        selectedChapters.forEach(round => {
            poolSize += chineseData[round].length;
        });
        document.getElementById('total-pool-count').innerText = poolSize;
        
        document.getElementById('view-chapters').style.display = 'none';
        document.getElementById('view-settings').style.display = 'flex';
        document.getElementById('tab-bar').style.display = 'none'; 
        document.getElementById('page-title').innerText = "設定題數";
    }

    function backToChapters() {
        document.getElementById('view-settings').style.display = 'none';
        document.getElementById('view-chapters').style.display = 'flex';
        document.getElementById('tab-bar').style.display = 'flex';
        document.getElementById('page-title').innerText = "國文全能特訓";
    }

    function selectCount(num) {
        selectedCount = num;
        document.getElementById('custom-count').value = "";
        document.querySelectorAll('.num-btn').forEach(btn => btn.classList.remove('active'));
        
        if(num === 10) document.querySelectorAll('.num-btn')[0].classList.add('active');
        if(num === 20) document.querySelectorAll('.num-btn')[1].classList.add('active');
        if(num === 50) document.querySelectorAll('.num-btn')[2].classList.add('active');
        if(num === 0) document.getElementById('btn-all').classList.add('active');
    }

    function clearQuickSelect() {
        document.querySelectorAll('.num-btn').forEach(btn => btn.classList.remove('active'));
        const val = parseInt(document.getElementById('custom-count').value);
        selectedCount = isNaN(val) ? 0 : val;
    }

    // --- 4. 測驗核心邏輯 ---
    function startQuiz() {
        let pool = [];
        selectedChapters.forEach(round => {
            pool = pool.concat(chineseData[round]);
        });

        let finalCount = pool.length;
        if (selectedCount > 0 && selectedCount < pool.length) {
            finalCount = selectedCount;
        }

        let questions = JSON.parse(JSON.stringify(pool));
        shuffle(questions);
        quizList = questions.slice(0, finalCount);

        quizList.forEach(q => {
            q.shuffledOptions = shuffle([...q.o]);
            q.shuffledOptions = [...new Set(q.shuffledOptions)];
        });

        document.getElementById('view-settings').style.display = 'none';
        document.getElementById('view-quiz').style.display = 'flex';
        document.getElementById('page-title').innerText = "測驗中";
        document.getElementById('btn-exit').style.display = 'block';
        
        currentIdx = 0;
        score = 0;
        mistakes = [];
        loadQuestion();
    }

    function loadQuestion() {
        document.getElementById('explanation-area').style.display = 'none';
        document.getElementById('btn-next').style.display = 'none';
        
        if (currentIdx >= quizList.length) {
            endQuiz();
            return;
        }

        const qData = quizList[currentIdx];
        
        document.getElementById('q-progress').innerText = `${currentIdx + 1} / ${quizList.length}`;
        document.getElementById('q-score').innerText = `得分: ${Math.round(score)}`;
        document.getElementById('bar-fill').style.width = `${((currentIdx) / quizList.length) * 100}%`;
        
        document.getElementById('q-word').innerHTML = qData.q;

        const optArea = document.getElementById('options-area');
        optArea.innerHTML = ''; 
        qData.shuffledOptions.forEach(optChar => {
            const btn = document.createElement('button');
            btn.className = 'opt-btn';
            btn.innerText = optChar;
            btn.onclick = () => checkAnswer(btn, optChar, qData);
            optArea.appendChild(btn);
        });
    }

    function checkAnswer(btn, userAns, qData) {
        const allBtns = document.querySelectorAll('.opt-btn');
        allBtns.forEach(b => b.disabled = true);

        let isCorrect = (userAns === qData.a);

        if (isCorrect) {
            btn.classList.add('correct');
            score += (100 / quizList.length);
        } else {
            btn.classList.add('wrong');
            allBtns.forEach(b => {
                if (b.innerText === qData.a) b.classList.add('correct');
            });
            mistakes.push(qData);
        }

        showExplanation(qData);
        document.getElementById('btn-next').style.display = 'block';
        
        setTimeout(() => {
            document.querySelector('.container').scrollTo({
                top: document.querySelector('.container').scrollHeight,
                behavior: 'smooth'
            });
        }, 100);
    }

    function showExplanation(qData) {
        document.getElementById('exp-meaning').innerText = qData.m || "（暫無釋義）";
        
        // 字義欄位：如果沒資料就隱藏這行，讓介面更乾淨
        const charRow = document.getElementById('exp-char-row');
        if (qData.cm && qData.cm.trim() !== "") {
            document.getElementById('exp-char').innerText = qData.cm;
            charRow.style.display = 'block';
        } else {
            charRow.style.display = 'none';
        }
        
        const srcDiv = document.getElementById('exp-source-row');
        if (qData.src && qData.src.trim() !== "") {
            document.getElementById('exp-source').innerText = qData.src;
            srcDiv.style.display = 'block';
        } else {
            srcDiv.style.display = 'none';
        }
        document.getElementById('explanation-area').style.display = 'block';
    }

    function nextQuestion() {
        currentIdx++;
        loadQuestion();
        document.querySelector('.container').scrollTo({ top: 0, behavior: 'smooth' });
    }

    function quitQuiz() {
        if(confirm("確定要中途結束測驗嗎？(目前進度將不會儲存)")) {
            endQuiz();
        }
    }

    function endQuiz() {
        document.getElementById('view-quiz').style.display = 'none';
        document.getElementById('view-result').style.display = 'flex';
        document.getElementById('page-title').innerText = "測驗結果";
        document.getElementById('btn-exit').style.display = 'none';
        document.getElementById('tab-bar').style.display = 'none'; 
        
        document.getElementById('final-score').innerText = Math.round(score);

        const area = document.getElementById('mistake-area');
        const list = document.getElementById('mistake-list');
        
        if (mistakes.length > 0) {
            area.style.display = 'block';
            list.innerHTML = '';
            mistakes.forEach(m => {
                const div = document.createElement('div');
                div.className = 'mistake-item';
                // 處理題目中的填空顯示
                let displayQ = m.q;
                if(displayQ.includes('「 」')) {
                    displayQ = displayQ.replace('「 」', `「<span class="correct-char">${m.a}</span>」`);
                } else {
                    displayQ += ` <span class="correct-char">➡ ${m.a}</span>`;
                }

                div.innerHTML = `
                    <div style="font-weight:bold; margin-bottom:5px; font-size:1.2rem;">
                        ${displayQ}
                    </div>
                    <div style="font-size:0.95rem; color:#555;">釋義：${m.m || ''}</div>
                `;
                list.appendChild(div);
            });
        } else {
            area.style.display = 'none';
        }
    }

    function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }
</script>
</body>
</html>
