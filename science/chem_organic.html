<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é«˜ä¸­åŒ–å­¸å…¨èƒ½ç‰¹è¨“</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* æ²¿ç”¨è‹±æ–‡ç‰ˆçš„ä¸»é¡Œè‰² (ç´«è‰²æ¼¸å±¤)ï¼Œä½†å¡ç‰‡å…§ä¿ç•™åŒ–å­¸ç¶  */
            --app-bg-start: #667eea;
            --app-bg-end: #764ba2;
            --primary: #0d9488; /* åŒ–å­¸ç¶  */
            --primary-light: #ccfbf1;
            --text: #1e293b;
            --gray: #64748b;
            --success: #059669;
            --error: #dc2626;
            --slot-bg: #e2e8f0;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg, var(--app-bg-start) 0%, var(--app-bg-end) 100%);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 800px;
            background: rgba(255, 255, 255, 0.98);
            min-height: 90vh;
            border-radius: 24px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* --- Header --- */
        header {
            text-align: center;
            padding: 20px;
            background: #fff;
            position: sticky;
            top: 0;
            z-index: 50;
            border-bottom: 1px solid #e2e8f0;
        }
        .back-btn {
            position: absolute; left: 15px; top: 20px;
            background: #f1f5f9; border: none; padding: 6px 14px; border-radius: 20px;
            font-size: 0.9rem; color: var(--gray); font-weight: bold; cursor: pointer; text-decoration: none;
        }
        h1 { margin: 0; font-size: 1.5rem; color: #333; letter-spacing: 1px; }

        /* --- Tab åˆ‡æ› --- */
        .tab-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            padding: 15px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }
        .tab-btn {
            padding: 10px 24px;
            border: none;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: bold;
            color: var(--gray);
            background: #e2e8f0;
            cursor: pointer;
            transition: 0.3s;
        }
        .tab-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 10px rgba(13, 148, 136, 0.3);
        }

        /* --- å…§å®¹å€å¡Š --- */
        .view-section { display: none; padding: 20px; flex: 1; overflow-y: auto; }
        .view-section.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- [View 1] ç­†è¨˜æ¨¡å¼ --- */
        .note-card {
            background: #fff; border-radius: 12px; padding: 25px; margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-left: 5px solid var(--primary); border-top: 1px solid #f1f5f9;
        }
        h2 { color: #0f766e; margin-top: 0; margin-bottom: 20px; font-size: 1.3rem; border-bottom: 1px dashed #cbd5e1; padding-bottom: 10px; }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.95rem; min-width: 600px; }
        .table-wrapper { overflow-x: auto; }
        th { background-color: var(--primary); color: white; padding: 12px; text-align: left; white-space: nowrap; }
        td { border-bottom: 1px solid #e2e8f0; padding: 12px; vertical-align: top; }
        tr:nth-child(even) { background-color: #f8fafc; }
        
        .formula { font-family: 'Courier New', monospace; background: #f3e8ff; padding: 2px 6px; border-radius: 4px; color: #7e22ce; font-weight: bold; }
        .highlight { color: #b45309; font-weight: bold; background: #fffbeb; padding: 0 3px; }
        
        /* æ¨™ç±¤ */
        .tag { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem; color: white; margin-bottom: 5px; font-weight: bold; }
        .tag-med { background: #ef4444; } .tag-clean { background: #3b82f6; } 
        .tag-poly { background: #8b5cf6; } .tag-food { background: #10b981; } .tag-energy { background: #f59e0b; }

        /* --- [View 2] æ¸¬é©—é¸å–® --- */
        .stats-panel {
            background: var(--primary); color: white; padding: 20px; border-radius: 16px;
            margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 5px 15px rgba(13, 148, 136, 0.3);
        }
        .chapter-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding-bottom: 80px; }
        .chapter-card {
            background: #f8fafc; border: 2px solid transparent; border-radius: 12px; padding: 15px;
            cursor: pointer; transition: 0.2s; position: relative; overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); min-height: 90px; display: flex; flex-direction: column; justify-content: center;
        }
        .chapter-card.selected { border-color: var(--primary); background-color: var(--primary-light); }
        .chapter-card.selected::after {
            content: 'âœ“'; position: absolute; top: 5px; right: 5px; background: var(--primary); color: white;
            border-radius: 50%; width: 20px; height: 20px; font-size: 12px; display: flex; align-items: center; justify-content: center;
        }
        .ch-title { font-weight: bold; font-size: 1.05rem; margin-bottom: 5px; color: #333; }
        .ch-count { font-size: 0.85rem; color: var(--gray); }

        /* åº•éƒ¨æ‡¸æµ®æŒ‰éˆ• */
        .bottom-dock {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: rgba(255, 255, 255, 0.9); padding: 15px 20px;
            border-top: 1px solid #e2e8f0; backdrop-filter: blur(5px);
            z-index: 100;
        }
        .start-btn {
            width: 100%; padding: 15px; border: none; border-radius: 30px;
            font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: 0.2s;
            background: var(--primary); color: white;
            box-shadow: 0 4px 10px rgba(13, 148, 136, 0.3);
        }
        .start-btn:disabled { background: #cbd5e1; box-shadow: none; cursor: not-allowed; }
        .start-btn:active { transform: scale(0.98); }

        /* --- æ¸¬é©—é€²è¡Œä¸­ --- */
        .quiz-status { display: flex; justify-content: space-between; margin-bottom: 10px; font-weight: bold; color: var(--gray); font-size: 0.9rem; }
        .progress-bar { height: 8px; background: #e2e8f0; border-radius: 4px; margin-bottom: 25px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: 0.3s; }
        
        .question-box {
            min-height: 180px; display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: white; border-radius: 16px; padding: 25px; margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); text-align: center; border: 1px solid #f1f5f9;
        }
        .q-text { font-size: 1.3rem; font-weight: 800; color: #333; line-height: 1.5; }
        
        /* é¸æ“‡é¡ŒæŒ‰éˆ• */
        .options-grid { display: grid; gap: 12px; }
        .opt-btn {
            background: white; border: 2px solid #e2e8f0; padding: 18px; border-radius: 12px;
            font-size: 1rem; text-align: left; cursor: pointer; transition: 0.2s; color: var(--text);
            font-weight: 500;
        }
        .opt-btn:active { background: #f1f5f9; }
        .opt-btn.correct { background: #dcfce7; border-color: var(--success); color: #166534; font-weight: bold; }
        .opt-btn.wrong { background: #fee2e2; border-color: var(--error); color: #991b1b; }

        /* å¡«ç©ºé¡Œæ¨£å¼ */
        .drop-slot {
            display: inline-flex; min-width: 80px; height: 36px; background: var(--slot-bg);
            border-bottom: 3px solid #94a3b8; border-radius: 6px; margin: 0 5px;
            vertical-align: middle; align-items: center; justify-content: center;
            color: #64748b; font-weight: bold; padding: 0 8px; font-size: 1rem;
        }
        .drop-slot.filled { background: transparent; border: none; border-bottom: 3px solid var(--primary); color: var(--primary); }
        .drop-slot.error { color: var(--error); border-bottom-color: var(--error); }
        
        .drag-pool { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-top: 10px; }
        .drag-item {
            background: white; border: 2px solid var(--primary); color: var(--primary);
            padding: 8px 16px; border-radius: 20px; font-weight: bold; cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); font-size: 1rem;
        }

        /* è§£æèˆ‡å½ˆçª— */
        .feedback-box {
            display: none; background: #f0fdfa; padding: 20px; border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05); margin-top: 20px; text-align: left;
            border: 1px solid var(--primary); animation: slideUp 0.3s;
        }
        
        .modal-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);
            display: none; justify-content: center; align-items: center; z-index: 100; backdrop-filter: blur(3px);
        }
        .modal {
            background: white; padding: 30px; border-radius: 20px; width: 85%; max-width: 350px;
            text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.2); animation: popIn 0.3s;
        }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .num-input {
            font-size: 2rem; padding: 10px; width: 100px; text-align: center;
            border: 2px solid #cbd5e1; border-radius: 12px; margin: 20px 0; color: var(--primary); font-weight: bold;
        }
        .modal-btns { display: flex; gap: 12px; margin-top: 20px; }

        /* çµæœé  */
        .result-box { text-align: center; background: white; padding: 40px; border-radius: 20px; margin-bottom: 20px; }
        .final-score { font-size: 4.5rem; font-weight: 800; color: var(--primary); line-height: 1; margin-bottom: 10px; }
        .mistake-card {
            background: white; padding: 15px; border-radius: 10px; border-left: 4px solid var(--error);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 10px; text-align: left;
        }

        /* SVG */
        .atom-c { fill: #333; font-weight:bold; font-family: Arial; font-size: 24px; text-anchor: middle; dominant-baseline: middle;}
        .atom-o { fill: #ef4444; font-weight:bold; font-family: Arial; font-size: 24px; text-anchor: middle; dominant-baseline: middle;}
        .atom-n { fill: #3b82f6; font-weight:bold; font-family: Arial; font-size: 24px; text-anchor: middle; dominant-baseline: middle;}
        .atom-h { fill: #666; font-weight:normal; font-family: Arial; font-size: 18px; text-anchor: middle; dominant-baseline: middle;}
        .bond { stroke: #333; stroke-width: 3; stroke-linecap: round; }
    </style>
</head>
<body>

<div class="container">
    
    <header>
        <a href="../index.html" class="back-btn">â† ç¸½éƒ¨</a>
        <h1>æœ‰æ©ŸåŒ–å­¸å…¨èƒ½ç‰¹è¨“</h1>
    </header>

    <!-- åˆ†é æŒ‰éˆ• -->
    <div class="tab-container">
        <button class="tab-btn active" onclick="switchView('note')">ğŸ“– ç­†è¨˜æ¨¡å¼</button>
        <button class="tab-btn" onclick="switchView('quiz')">ğŸ“ æ¸¬é©—å°ˆå€</button>
    </div>

    <!-- ==================== View 1: ç­†è¨˜æ¨¡å¼ ==================== -->
    <div id="view-note" class="view-section active">
        <!-- 1. åå¤§å®˜èƒ½åŸº -->
        <div class="note-card">
            <h2>ä¸€ã€æœ‰æ©Ÿå®˜èƒ½åŸºç¸½è¡¨</h2>
            <div class="table-wrapper">
                <table>
                    <thead><tr><th>å®¶æ—</th><th>å®˜èƒ½åŸº</th><th>é€šå¼</th><th>ä»£è¡¨åŒ–åˆç‰©</th><th>è€ƒè©¦è¨˜æ†¶é»</th></tr></thead>
                    <tbody>
                        <tr><td><strong>1. é†‡é¡</strong></td><td>-OH</td><td>R-OH</td><td><span class="formula">C<sub>2</sub>H<sub>5</sub>OH</span></td><td>æ˜“æº¶æ–¼æ°´ã€ä¸­æ€§ã€‚</td></tr>
                        <tr><td><strong>2. é†šé¡</strong></td><td>-O-</td><td>R-O-R'</td><td><span class="formula">CH<sub>3</sub>OCH<sub>3</sub></span></td><td>é†‡çš„åŒåˆ†ç•°æ§‹ç‰©ã€‚</td></tr>
                        <tr><td><strong>3. é†›é¡</strong></td><td>-CHO</td><td>R-CHO</td><td><span class="formula">HCHO</span></td><td><span class="highlight">æœ‰é‚„åŸåŠ›</span> (éŠ€é¡)ã€‚</td></tr>
                        <tr><td><strong>4. é…®é¡</strong></td><td>-CO-</td><td>R-CO-R'</td><td><span class="formula">CH<sub>3</sub>COCH<sub>3</sub></span></td><td>ç„¡é‚„åŸåŠ›ï¼Œæº¶åŠ‘ã€‚</td></tr>
                        <tr><td><strong>5. ç¾§é…¸</strong></td><td>-COOH</td><td>R-COOH</td><td><span class="formula">CH<sub>3</sub>COOH</span></td><td><span class="highlight">å¼±é…¸æ€§</span>ã€‚</td></tr>
                        <tr><td><strong>6. é…¯é¡</strong></td><td>-COO-</td><td>R-COO-R'</td><td>ä¹™é…¸ä¹™é…¯</td><td><span class="highlight">æ°´æœé¦™</span>ï¼Œé›£æº¶ã€‚</td></tr>
                        <tr><td><strong>7. èƒºé¡</strong></td><td>-NH<sub>2</sub></td><td>R-NH<sub>2</sub></td><td>è‹¯èƒº</td><td><span class="highlight">å¼±é¹¼æ€§</span>ï¼Œé­šè…¥ã€‚</td></tr>
                        <tr><td><strong>8. é†¯èƒº</strong></td><td>-CONH<sub>2</sub></td><td>R-CONH<sub>2</sub></td><td>ä¹™é†¯èƒº</td><td>ä¸­æ€§ï¼Œè‚½éµã€‚</td></tr>
                        <tr><td><strong>9. é…šé¡</strong></td><td>Ar-OH</td><td>C<sub>6</sub>H<sub>5</sub>OH</td><td>è‹¯é…š</td><td><span class="highlight">å¼±é…¸æ€§</span>ï¼Œæ°¯åŒ–éµç´«è‰²ã€‚</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 2. ç”Ÿæ´»åŒ–å­¸ -->
        <div class="note-card">
            <h2>äºŒã€ç”Ÿæ´»åŒ–å­¸ vs. çµæ§‹</h2>
            <div class="table-wrapper">
                <table>
                    <thead><tr><th>åˆ†é¡</th><th>åç¨±</th><th>çµæ§‹ç‰¹å¾µ</th><th>åŸç†èˆ‡è€ƒé»</th></tr></thead>
                    <tbody>
                        <tr><td><span class="tag tag-med">é†«è—¥</span></td><td><strong>é˜¿æ–¯åŒ¹éˆ</strong></td><td>ç¾§åŸº+é…¯åŸº</td><td>æ°´æ¥Šé…¸+ä¹™é…é…¯åŒ–ã€‚<span class="highlight">å‚·èƒƒ</span>ã€‚</td></tr>
                        <tr><td><span class="tag tag-clean">æ¸…æ½”</span></td><td><strong>è‚¥çš‚</strong></td><td>ç¾§é…¸é¹½</td><td>æ²¹è„‚çš‚åŒ–ã€‚<span class="highlight">æ€•ç¡¬æ°´</span>ã€‚</td></tr>
                        <tr><td><span class="tag tag-poly">èšåˆç‰©</span></td><td><strong>PET</strong></td><td>é…¯åŸº</td><td><span class="highlight">ç¸®åˆèšåˆ</span>ï¼Œå¯¶ç‰¹ç“¶ã€‚</td></tr>
                        <tr><td><span class="tag tag-poly">èšåˆç‰©</span></td><td><strong>è€ç¶¸</strong></td><td>é†¯èƒºåŸº</td><td><span class="highlight">ç¸®åˆèšåˆ</span>ï¼Œå«æ°®ã€‚</td></tr>
                        <tr><td><span class="tag tag-food">é£Ÿå“</span></td><td><strong>è‘¡è„ç³–</strong></td><td>å¤šç¾¥åŸºé†›</td><td>æœ‰é†›åŸºæ•…æœ‰<span class="highlight">é‚„åŸåŠ›</span>ã€‚</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ==================== View 2: æ¸¬é©—å°ˆå€ ==================== -->
    <div id="view-quiz" class="view-section">
        
        <!-- 1. æ¸¬é©—é¸å–® -->
        <div id="quiz-menu">
            <div class="stats-panel">
                <div style="font-size:0.9rem;">å·²é¸ <span id="selected-count" style="font-weight:bold; color:#ccfbf1; font-size:1.2rem;">0</span> å€‹å–®å…ƒ</div>
                <div style="font-size:0.9rem;">å…± <span id="total-selected-items" style="font-weight:bold; font-size:1.2rem;">0</span> é¡Œ</div>
            </div>

            <div class="chapter-grid" id="chapter-list">
                <!-- JS ç”Ÿæˆç« ç¯€ -->
            </div>

            <div class="bottom-dock">
                <button class="start-btn" id="btn-start-quiz" onclick="prepareQuiz()" disabled>ğŸ“ è¨­å®šé¡Œæ•¸ä¸¦é–‹å§‹</button>
            </div>
        </div>

        <!-- 2. æ¸¬é©—é€²è¡Œä¸­ -->
        <div id="quiz-play" style="display:none;">
            <div class="quiz-status">
                <span>é¡Œç›® <span id="q-curr">1</span> / <span id="q-total">10</span></span>
                <span>åˆ†æ•¸: <span id="score">0</span></span>
            </div>
            <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>

            <!-- é¡Œç›®å€å¡Š -->
            <div id="question-area"></div>

            <!-- é¸é …å€å¡Š (æœƒè®Šå‹•) -->
            <div id="answer-area"></div>

            <!-- è§£æå€å¡Š -->
            <div id="feedback" class="feedback-box">
                <div id="feedback-text" style="margin-bottom:15px; font-size:1rem; line-height:1.5;"></div>
                <button class="tab-btn active" style="width:100%" onclick="nextQuestion()">ä¸‹ä¸€é¡Œ â”</button>
            </div>

            <div style="text-align:center; margin-top:30px;">
                <button style="background:none; border:none; color:#64748b; font-weight:bold; cursor:pointer;" onclick="switchView('quiz')">
                    é€€å‡ºæ¸¬é©—
                </button>
            </div>
        </div>

        <!-- 3. çµæœé  -->
        <div id="quiz-result" style="display:none;">
            <div class="result-box">
                <div class="final-score" id="final-score">100</div>
                <div class="final-label">æ¸¬é©—å¾—åˆ†</div>
            </div>

            <button class="tab-btn active" onclick="retryQuiz()" style="width:100%; margin-bottom:15px;">å†æ¸¬ä¸€æ¬¡</button>
            <button class="tab-btn" onclick="switchView('quiz')" style="width:100%;">å›æ¸¬é©—é¸å–®</button>

            <div id="mistake-section" style="display:none; margin-top:30px;">
                <h3 style="color:var(--error); text-align:center; margin-bottom:15px;">âš ï¸ éœ€åŠ å¼·çš„è§€å¿µ</h3>
                <div id="mistake-list" class="mistake-list"></div>
            </div>
        </div>
    </div>

    <!-- å½ˆçª—ï¼šé¡Œæ•¸è¨­å®š -->
    <div id="quiz-settings-modal" class="modal-overlay">
        <div class="modal">
            <h3>è¨­å®šæ¸¬é©—é¡Œæ•¸</h3>
            <p style="color:#64748b; margin-bottom:0;">ç¯„åœç¸½é¡Œæ•¸ï¼š<span id="modal-total-items" style="color:#0d9488; font-weight:bold;">0</span></p>
            <input type="number" id="quiz-num-input" class="num-input" value="10" min="5">
            <div class="modal-btns">
                <button class="tab-btn" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="tab-btn active" onclick="confirmStartQuiz()">é–‹å§‹</button>
            </div>
        </div>
    </div>

</div>

<script>
    // ================= 1. è³‡æ–™åº« (30+ é¡Œ) =================
    
    const chemData = {
        "åŸºç¤å®˜èƒ½åŸº": [
            { type: 'image_choice', svg: `<svg viewBox="0 0 100 60"><line x1="10" y1="30" x2="40" y2="30" class="bond"/><text x="60" y="30" class="atom-o">O</text><text x="85" y="30" class="atom-h">H</text></svg>`, q: "é€™å€‹ã€Œ-OHã€çµæ§‹å±¬æ–¼ä»€éº¼å®˜èƒ½åŸºï¼Ÿ", a: "ç¾¥åŸº", o: ["ç¾§åŸº", "ç¾¥åŸº", "é†›åŸº", "ç¾°åŸº"], exp: "-OH æ˜¯ç¾¥åŸºã€‚é†‡é¡å’Œé…šé¡éƒ½æœ‰å®ƒã€‚" },
            { type: 'image_choice', svg: `<svg viewBox="0 0 120 80"><line x1="10" y1="40" x2="40" y2="40" class="bond"/><text x="55" y="40" class="atom-c">C</text><line x1="65" y1="25" x2="80" y2="10" class="bond"/><text x="90" y="10" class="atom-o">O</text><line x1="70" y1="30" x2="85" y2="15" class="bond"/><line x1="65" y1="50" x2="80" y2="65" class="bond"/><text x="90" y="70" class="atom-h">H</text></svg>`, q: "ã€Œ-CHOã€æ˜¯å“ªç¨®å®˜èƒ½åŸºï¼Ÿ", a: "é†›åŸº", o: ["é…®åŸº", "ç¾§åŸº", "é†›åŸº", "é…¯åŸº"], exp: "é†›åŸºç‰¹å¾µæ˜¯ C=O é›™éµæœ«ç«¯æ¥ä¸€å€‹ Hã€‚" },
            { type: 'image_choice', svg: `<svg viewBox="0 0 120 80"><line x1="10" y1="40" x2="40" y2="40" class="bond"/><text x="55" y="40" class="atom-c">C</text><line x1="65" y1="25" x2="80" y2="10" class="bond"/><text x="90" y="10" class="atom-o">O</text><line x1="70" y1="30" x2="85" y2="15" class="bond"/><line x1="65" y1="50" x2="80" y2="65" class="bond"/><text x="90" y="70" class="atom-o">O</text><text x="110" y="70" class="atom-h">H</text></svg>`, q: "ã€Œ-COOHã€çµæ§‹æ˜¯ï¼Ÿ", a: "ç¾§åŸº", o: ["é…¯åŸº", "ç¾§åŸº", "ç¾¥åŸº", "ç¾°åŸº"], exp: "ç¾§åŸºæ˜¯æœ‰æ©Ÿé…¸çš„ç‰¹å¾µï¼Œå‘ˆå¼±é…¸æ€§ã€‚" },
            { type: 'image_choice', svg: `<svg viewBox="0 0 120 80"><text x="20" y="40" class="atom-c">C</text><line x1="30" y1="40" x2="60" y2="40" class="bond"/><text x="75" y="40" class="atom-o">O</text><line x1="90" y1="40" x2="110" y2="40" class="bond"/><text x="120" y="40" class="atom-c">C</text></svg>`, q: "ç¢³èˆ‡ç¢³ä¸­é–“å¤¾ä¸€å€‹æ°§ã€ŒC-O-Cã€ï¼Œé€™æ˜¯ï¼Ÿ", a: "é†šé¡", o: ["é…¯é¡", "é…®é¡", "é†šé¡", "é†‡é¡"], exp: "é†šé¡çµæ§‹è¼ƒç©©å®šï¼Œå¦‚ç”²é†šã€‚" },
            { type: 'image_choice', svg: `<svg viewBox="0 0 120 80"><text x="20" y="40" class="atom-c">C</text><line x1="35" y1="25" x2="50" y2="10" class="bond"/><text x="60" y="10" class="atom-o">O</text><line x1="40" y1="30" x2="55" y2="15" class="bond"/><line x1="30" y1="50" x2="50" y2="65" class="bond"/><text x="60" y="70" class="atom-o">O</text><line x1="75" y1="70" x2="95" y2="70" class="bond"/><text x="105" y="70" class="atom-c">C</text></svg>`, q: "çœ‹åˆ°ã€Œ-COO-ã€çµæ§‹ï¼Œé€šå¸¸å…·æœ‰é¦™å‘³ï¼Œå®ƒæ˜¯ï¼Ÿ", a: "é…¯åŸº", o: ["ç¾§åŸº", "é…¯åŸº", "é†šåŸº", "é…®åŸº"], exp: "é…¯åŸºå¸¸è¦‹æ–¼æ°´æœé¦™å‘³å’Œæ²¹è„‚ä¸­ï¼Œä¸æº¶æ–¼æ°´ã€‚" },
            { type: 'image_choice', svg: `<svg viewBox="0 0 100 60"><line x1="10" y1="30" x2="40" y2="30" class="bond"/><text x="55" y="30" class="atom-n">N</text><text x="80" y="15" class="atom-h">H</text><text x="80" y="45" class="atom-h">H</text></svg>`, q: "ã€Œ-NHâ‚‚ã€çµæ§‹ç¨±ç‚ºä»€éº¼ï¼Ÿ", a: "èƒºåŸº", o: ["èƒºåŸº", "é†¯èƒºåŸº", "ç¡åŸº", "æ°¨åŸº"], exp: "èƒºåŸºå…·æœ‰å­¤å°é›»å­ï¼Œè¡¨ç¾å‡ºå¼±é¹¼æ€§ã€‚" },
            { type: 'image_choice', svg: `<svg viewBox="0 0 140 80"><text x="20" y="40" class="atom-c">C</text><line x1="30" y1="25" x2="45" y2="10" class="bond"/><text x="55" y="10" class="atom-o">O</text><line x1="35" y1="30" x2="50" y2="15" class="bond"/><line x1="30" y1="50" x2="50" y2="50" class="bond"/><text x="65" y="50" class="atom-n">N</text><text x="85" y="50" class="atom-h">H</text><line x1="95" y1="50" x2="115" y2="50" class="bond"/></svg>`, q: "ã€Œ-CONH-ã€çµæ§‹åœ¨è›‹ç™½è³ªä¸­è¢«ç¨±ç‚ºï¼Ÿ", a: "è‚½éµ", o: ["æ°«éµ", "é›¢å­éµ", "è‚½éµ", "é…¯éµ"], exp: "é€™æ˜¯é†¯èƒºåŸº (è‚½éµ)ï¼Œé€£æ¥èƒºåŸºé…¸å½¢æˆè›‹ç™½è³ªã€‚" },
            { type: 'image_choice', svg: `<svg viewBox="0 0 120 80"><text x="20" y="50" class="atom-c">C</text><line x1="35" y1="35" x2="50" y2="20" class="bond"/><text x="60" y="20" class="atom-o">O</text><line x1="40" y1="40" x2="55" y2="25" class="bond"/><line x1="35" y1="60" x2="70" y2="60" class="bond"/><text x="80" y="60" class="atom-c">C</text></svg>`, q: "ç¢³èˆ‡ç¢³ä¹‹é–“å¤¾è‘—ã€ŒC=Oã€ï¼Œå…©é‚Šéƒ½æ¥ç¢³ï¼Œé€™æ˜¯ï¼Ÿ", a: "é…®åŸº", o: ["é†›åŸº", "é…®åŸº", "ç¾§åŸº", "é†šåŸº"], exp: "é€™æ˜¯é…®åŸºã€‚æœ€ç°¡å–®çš„é…®æ˜¯ä¸™é…®(å»å…‰æ°´)ã€‚" },
            { type: 'fill', pre: "çµæ§‹å¼ç‚º R-OH çš„å®˜èƒ½åŸºç¨±ç‚º", post: "ï¼Œå…·æœ‰è¦ªæ°´æ€§ã€‚", ans: "ç¾¥åŸº", opts: ["ç¾§åŸº", "é†›åŸº", "ç¾°åŸº"], exp: "-OH æ˜¯ç¾¥åŸº (Hydroxyl group)ã€‚" },
            { type: 'fill', pre: "é†›åŸºçš„çµæ§‹å¼ç‚º", post: "ï¼Œå…·æœ‰é‚„åŸæ€§ã€‚", ans: "-CHO", opts: ["-COOH", "-OH", "-COO-"], exp: "é†›åŸºå¯«ä½œ -CHOã€‚" },
            { type: 'fill', pre: "æœ‰æ©Ÿé…¸å¿…å®šå«æœ‰", post: "å®˜èƒ½åŸºï¼Œå‘ˆå¼±é…¸æ€§ã€‚", ans: "ç¾§åŸº", opts: ["é…¯åŸº", "ç¾¥åŸº", "é†›åŸº"], exp: "ç¾§åŸº (-COOH) é¡¯é…¸æ€§ã€‚" }
        ],
        "ç”Ÿæ´»èˆ‡ç’°å¢ƒ": [
            { type: 'text_choice', q: "é˜¿æ–¯åŒ¹éˆæ˜¯ç”±æ°´æ¥Šé…¸èˆ‡ä½•è€…åæ‡‰è£½æˆï¼Ÿ", a: "ä¹™é…", o: ["ä¹™é†‡", "ä¹™é…", "ä¹™é…¸", "ç”²é†‡"], exp: "é˜¿æ–¯åŒ¹éˆ(ä¹™é†¯æ°´æ¥Šé…¸)æ˜¯åˆ©ç”¨ä¹™é…å°‡æ°´æ¥Šé…¸é…¯åŒ–è€Œæˆã€‚" },
            { type: 'fill', pre: "é˜¿æ–¯åŒ¹éˆæ˜¯ç”±æ°´æ¥Šé…¸èˆ‡", post: "åæ‡‰è£½æˆã€‚", ans: "ä¹™é…", opts: ["ä¹™é†‡", "ä¹™é…¸", "ç”²é†‡"], exp: "æ°´æ¥Šé…¸ + ä¹™é… -> é˜¿æ–¯åŒ¹éˆã€‚" },
            { type: 'fill', pre: "è‚¥çš‚åœ¨ç¡¬æ°´ä¸­ç”¢ç”Ÿ", post: "ï¼Œå½±éŸ¿æ´—æ»Œã€‚", ans: "çš‚å¢", opts: ["æ³¡æ²«", "ç”˜æ²¹", "é…¸æ€§ç‰©è³ª"], exp: "ç¡¬æ°´ä¸­çš„éˆ£é‚é›¢å­æœƒå½¢æˆçš‚å¢ã€‚" },
            { type: 'text_choice', q: "ä¸‹åˆ—å“ªä¸€ç¨®å¡‘è† ç‡ƒç‡’æ™‚æ˜“ç”¢ç”Ÿæˆ´å¥§è¾›ï¼Ÿ", a: "PVC", o: ["PE", "PP", "PVC", "PET"], exp: "PVC (èšæ°¯ä¹™çƒ¯) å«æ°¯ï¼Œç‡ƒç‡’ä¸å®Œå…¨æ˜“ç”Ÿæˆ´å¥§è¾›ã€‚" },
            { type: 'fill', pre: "è€ç¶¸ (Nylon) çµæ§‹ä¸­å«æœ‰", post: "å…ƒç´ ã€‚", ans: "æ°®", opts: ["æ°¯", "ç¡«", "ç£·"], exp: "è€ç¶¸æ˜¯èšé†¯èƒºï¼Œå«æ°®ã€‚" },
            { type: 'fill', pre: "æ±½æ²¹çš„è¾›çƒ·å€¼ä»£è¡¨", post: "èƒ½åŠ›ã€‚", ans: "æŠ—éœ‡çˆ†", opts: ["ç‡ƒç‡’", "æ½¤æ»‘", "æ®ç™¼"], exp: "è¾›çƒ·å€¼è¶Šé«˜ï¼ŒæŠ—éœ‡çˆ†è¶Šå¥½ã€‚" },
            { type: 'fill', pre: "é€ æˆã€Œé…¸é›¨ã€çš„ä¸»è¦æ°£é«”æ˜¯ç¡«æ°§åŒ–ç‰© (SOx) èˆ‡", post: "ã€‚", ans: "æ°®æ°§åŒ–ç‰©", opts: ["äºŒæ°§åŒ–ç¢³", "ç”²çƒ·", "è‡­æ°§"], exp: "SOx èˆ‡ NOx æº¶æ–¼æ°´æœƒå½¢æˆé…¸é›¨ã€‚" },
            { type: 'fill', pre: "æº«å®¤æ•ˆæ‡‰çš„ä¸»è¦å…ƒå…‡æ˜¯", post: "ã€‚", ans: "äºŒæ°§åŒ–ç¢³", opts: ["æ°§æ°£", "æ°®æ°£", "æ°«æ°£"], exp: "é›–ç„¶æ°´æ°£ä¹Ÿæ˜¯ï¼Œä½†äººé¡æ´»å‹•ä¸»è¦å¢åŠ çš„æ˜¯ CO2ã€‚" },
            { type: 'fill', pre: "è‡ªä¾†æ°´å» é€šå¸¸ä½¿ç”¨", post: "æ°£é«”ä¾†é€²è¡Œæ¶ˆæ¯’æ®ºèŒã€‚", ans: "æ°¯æ°£", opts: ["æ°«æ°£", "æ°®æ°£", "æ°¦æ°£"], exp: "æ°¯æ°£æº¶æ–¼æ°´ç”¢ç”Ÿæ¬¡æ°¯é…¸ï¼Œæœ‰å¼·æ°§åŒ–åŠ›ã€‚" },
            { type: 'fill', pre: "å¸‚å”®çš„ã€Œå‘³ç²¾ã€åŒ–å­¸æˆåˆ†æ˜¯", post: "ã€‚", ans: "éº©èƒºé…¸éˆ‰", opts: ["æ°¯åŒ–éˆ‰", "ç¢³é…¸éˆ‰", "è‹¯ç”²é…¸éˆ‰"], exp: "å‘³ç²¾æ˜¯éº©èƒºé…¸çš„éˆ‰é¹½ã€‚" },
            { type: 'fill', pre: "æ°´ä¿ç—…æ˜¯å› ç‚º", post: "æ±™æŸ“æ‰€å¼•èµ·çš„ç¥ç¶“æ¯’æ€§ç–¾ç—…ã€‚", ans: "æ±", opts: ["é˜", "é‰›", "ç ·"], exp: "ç”²åŸºæ±å°è‡´æ°´ä¿ç—…ã€‚" },
            { type: 'fill', pre: "ç—›ç—›ç—…æ˜¯å› ç‚º", post: "æ±™æŸ“æ‰€å°è‡´çš„éª¨éª¼ç—…è®Šã€‚", ans: "é˜", opts: ["æ±", "éŠ…", "é‰»"], exp: "é˜ç±³äº‹ä»¶å°è‡´ç—›ç—›ç—…ã€‚" },
            { tag: 'life', pre: "èƒƒè—¥ä¸­è‹¥å«æœ‰", post: "æˆåˆ†ï¼Œå®¹æ˜“å¼•èµ·ä¾¿ç§˜çš„å‰¯ä½œç”¨ã€‚", ans: "æ°«æ°§åŒ–é‹", opts: ["æ°«æ°§åŒ–é‚", "ç¢³é…¸éˆ£", "ç¢³é…¸æ°«éˆ‰"], exp: "é‹é¹½æ˜“ä¾¿ç§˜ï¼Œé‚é¹½æ˜“è…¹ç€‰ã€‚" },
            { tag: 'life', pre: "ç›¤å°¼è¥¿æ—çš„æŠ—èŒåŸç†æ˜¯ç ´å£ç´°èŒçš„", post: "åˆæˆã€‚", ans: "ç´°èƒå£", opts: ["ç´°èƒè†œ", "ç´°èƒæ ¸", "è›‹ç™½è³ª"], exp: "æŠ‘åˆ¶ç´°èƒå£è‚½èšé†£åˆæˆã€‚" },
            { tag: 'life', pre: "å›æ”¶æ¨™èªŒ 1 è™Ÿçš„å¡‘è† æ˜¯", post: "ï¼Œå¸¸ç”¨æ–¼å¯¶ç‰¹ç“¶ã€‚", ans: "PET", opts: ["HDPE", "PVC", "PP"], exp: "Polyethylene terephthalate (èšå°è‹¯äºŒç”²é…¸ä¹™äºŒé…¯)ã€‚" },
            { tag: 'life', pre: "è›‹ç™½è³ªé‡åˆ°å¼·é…¸ã€å¼·é¹¼æˆ–é«˜æº«æœƒå¤±å»æ´»æ€§ï¼Œç¨±ç‚º", post: "ã€‚", ans: "è®Šæ€§", opts: ["æ°´è§£", "èšåˆ", "ç™¼é…µ"], exp: "è®Šæ€§ (Denaturation) æ˜¯è›‹ç™½è³ªç«‹é«”çµæ§‹è¢«ç ´å£ã€‚" },
            { tag: 'life', pre: "DNA èˆ‡ RNA çµæ§‹ä¸Šçš„å·®ç•°ï¼Œé™¤äº†é¹¼åŸº U/T ä¸åŒå¤–ï¼Œé‚„æœ‰", post: "ä¸åŒã€‚", ans: "äº”ç¢³é†£", opts: ["ç£·é…¸", "æ°«éµ", "èºæ—‹"], exp: "DNA æ˜¯å»æ°§æ ¸ç³–ï¼ŒRNA æ˜¯æ ¸ç³–ã€‚" }
        ],
        "é€²éšæœ‰æ©Ÿåæ‡‰": [
            { type: 'fill', pre: "ä¸€ç´šé†‡æ°§åŒ–å¾Œæœƒå…ˆè®Šæˆ", post: "ï¼Œç¹¼çºŒæ°§åŒ–å‰‡è®Šæˆç¾§é…¸ã€‚", ans: "é†›", opts: ["é…®", "é…¯", "é†š"], exp: "ä¸€ç´šé†‡ -> é†› -> é…¸ã€‚" },
            { type: 'fill', pre: "è‹¯é…šçš„æ°´æº¶æ¶²å‘ˆå¼±é…¸æ€§ï¼Œä¿—ç¨±", post: "ã€‚", ans: "çŸ³ç‚­é…¸", opts: ["é†‹é…¸", "æ°´æ¥Šé…¸", "ç”²é…¸"], exp: "è‹¯é…šä¿—ç¨±çŸ³ç‚­é…¸ã€‚" },
            { type: 'fill', pre: "ä¹™ç‚”çš„çµæ§‹ç‰¹å¾µæ˜¯ç¢³èˆ‡ç¢³ä¹‹é–“æœ‰", post: "éµçµã€‚", ans: "åƒéµ", opts: ["é›™éµ", "å–®éµ", "é›¢å­éµ"], exp: "ç‚”é¡å«æœ‰ç¢³ç¢³åƒéµã€‚" },
            { type: 'fill', pre: "ç”²é†›çš„æ°´æº¶æ¶²ä¿—ç¨±", post: "ï¼Œå…·æœ‰é˜²è…ä½œç”¨ã€‚", ans: "ç¦é¦¬æ—", opts: ["ç”˜æ²¹", "é…’ç²¾", "å»å…‰æ°´"], exp: "37% çš„ç”²é†›æ°´æº¶æ¶²ç¨±ç‚ºç¦é¦¬æ—ã€‚" },
            { type: 'fill', pre: "ä¹™é…¸ä¹™é…¯æ˜¯ç”±ä¹™é…¸èˆ‡", post: "åæ‡‰è„«æ°´è€Œæˆçš„ã€‚", ans: "ä¹™é†‡", opts: ["ç”²é†‡", "ä¹™é†š", "ä¹™çƒ·"], exp: "é…¯åŒ–åæ‡‰ï¼šé…¸ + é†‡ -> é…¯ + æ°´ã€‚" },
            { type: 'fill', pre: "æª¢é©—ã€Œé…šé¡ã€çš„å­˜åœ¨ï¼Œå¯åŠ å…¥", post: "æº¶æ¶²ï¼Œæœƒå‘ˆç¾ç´«è‰²ã€‚", ans: "æ°¯åŒ–éµ", opts: ["æ–æ—è©¦åŠ‘", "å¤šå€«è©¦åŠ‘", "æº´æ°´"], exp: "é…šé¡é‡æ°¯åŒ–éµå‘ˆç´«è‰²ã€‚" },
            { type: 'fill', pre: "äºŒç´šèƒºçš„çµæ§‹ç‰¹å¾µæ˜¯æ°®åŸå­é€£æ¥äº†", post: "å€‹ç¢³åŸå­ã€‚", ans: "2", opts: ["1", "3", "4"], exp: "æ°®æ¥ 2 å€‹ç¢³æ˜¯äºŒç´šèƒºã€‚" },
            { type: 'fill', pre: "ä¸‹åˆ—ä½•è€…äº’ç‚ºã€Œå®˜èƒ½åŸºç•°æ§‹ç‰©ã€ï¼Ÿä¹™é†‡èˆ‡", post: "ã€‚", ans: "ç”²é†š", opts: ["ä¹™é…¸", "ä¹™é†›", "ä¸™é…®"], exp: "é†‡èˆ‡é†šäº’ç‚ºåŒåˆ†ç•°æ§‹ç‰©ã€‚" },
            { type: 'fill', pre: "é†¯èƒºåŸºåœ¨é…¸æ€§ç’°å¢ƒä¸‹æ°´è§£ï¼Œæœƒç”¢ç”Ÿ", post: "èˆ‡èƒºã€‚", ans: "ç¾§é…¸", opts: ["é†‡", "é†›", "é…®"], exp: "é†¯èƒºæ°´è§£ç”Ÿæˆé…¸ + èƒºã€‚" },
            { type: 'fill', pre: "å¤šå€«è©¦åŠ‘å«", post: "éŒ¯é›¢å­ï¼Œé‡é†›æœƒç”¢ç”ŸéŠ€é¡ã€‚", ans: "éŠ€æ°¨", opts: ["éŠ…æ°¨", "é‹…æ°¨", "éµæ°¨"], exp: "åˆç¨±éŠ€é¡åæ‡‰ã€‚" },
            { type: 'fill', pre: "æ–æ—è©¦åŠ‘å«", post: "é›¢å­ï¼Œé‡é†›å…±ç†±ç”¢ç”Ÿç´…è‰²æ²‰æ¾±ã€‚", ans: "éŠ…", opts: ["éŠ€", "éµ", "é‚"], exp: "Cu2+ è¢«é‚„åŸæˆ Cu2O (ç´…è‰²)ã€‚" },
            { type: 'fill', pre: "æª¢é©—ç¢³ç¢³é›™éµæˆ–åƒéµï¼Œå¯ä½¿ç”¨", post: "ï¼Œæœƒç™¼ç”Ÿè¤ªè‰²åæ‡‰ã€‚", ans: "æº´æ°´", opts: ["çŸ³è•Š", "é…šé…", "ç¢˜æ¶²"], exp: "æº´èˆ‡ä¸é£½å’Œçƒ´ç™¼ç”ŸåŠ æˆåæ‡‰ã€‚" },
            { type: 'fill', pre: "é¹µä»£çƒ´èˆ‡æ°«æ°§åŒ–éˆ‰æ°´æº¶æ¶²å…±ç†±ï¼Œæœƒç™¼ç”Ÿ", post: "åæ‡‰ç”Ÿæˆé†‡ã€‚", ans: "å–ä»£", opts: ["åŠ æˆ", "æ¶ˆå»", "é…¯åŒ–"], exp: "R-X + OH- -> R-OH + X-ã€‚" },
            { type: 'fill', pre: "è‹¯èˆ‡æ¿ƒç¡é…¸ã€æ¿ƒç¡«é…¸å…±ç†±ï¼Œç™¼ç”Ÿ", post: "åæ‡‰ç”Ÿæˆç¡åŸºè‹¯ã€‚", ans: "å–ä»£", opts: ["åŠ æˆ", "æ¶ˆå»", "ä¸­å’Œ"], exp: "è¦ªé›»èŠ³é¦™å–ä»£åæ‡‰ã€‚" },
            { type: 'fill', pre: "é…¯åŒ–åæ‡‰é€šå¸¸éœ€è¦åŠ å…¥", post: "ä½œç‚ºå‚¬åŒ–åŠ‘èˆ‡è„«æ°´åŠ‘ã€‚", ans: "æ¿ƒç¡«é…¸", opts: ["æ¿ƒé¹½é…¸", "æ¿ƒç¡é…¸", "æ°«æ°§åŒ–éˆ‰"], exp: "æ¿ƒç¡«é…¸å¸æ”¶ç”Ÿæˆçš„æ°´ï¼Œæé«˜ç”¢ç‡ã€‚" }
        ]
    };

    // ================= é é¢åˆå§‹åŒ–èˆ‡é¸å–® =================

    let selectedChapters = new Set();
    let currentList = [];
    let currentIndex = 0;
    let score = 0;
    let mistakes = [];

    // è‡ªå‹•åŸ·è¡Œï¼šè¨ˆç®—ä¸¦é¡¯ç¤ºç¸½é¡Œæ•¸
    let totalItems = 0;
    for (const cat in chemData) {
        totalItems += chemData[cat].length;
    }
    // æª¢æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨ï¼Œé¿å…å ±éŒ¯
    const totalEl = document.getElementById('total-db-items');
    if (totalEl) totalEl.innerText = totalItems;
    
    // åŸ·è¡Œé¸å–®ç¹ªè£½
    renderMenu();
    
    // è§£æ±ºç™½ç•«é¢å•é¡Œï¼šå¼·åˆ¶åŸ·è¡Œä¸€æ¬¡
    window.onload = function() {
        renderMenu();
    }

    function renderMenu() {
        const grid = document.getElementById('chapter-list');
        if (!grid) return;
        
        grid.innerHTML = "";
        
        Object.keys(chemData).forEach(cat => {
            const count = chemData[cat].length;
            const card = document.createElement('div');
            card.className = 'chapter-card';
            card.onclick = () => toggleSelection(card, cat);
            card.innerHTML = `
                <div class="ch-title">${cat}</div>
                <div class="ch-count">${count} é¡Œ</div>
            `;
            grid.appendChild(card);
        });
    }

    function toggleSelection(card, cat) {
        if (selectedChapters.has(cat)) {
            selectedChapters.delete(cat);
            card.classList.remove('selected');
        } else {
            selectedChapters.add(cat);
            card.classList.add('selected');
        }
        updateStats();
    }

    function updateStats() {
        document.getElementById('selected-count').innerText = selectedChapters.size;
        let currentTotal = 0;
        selectedChapters.forEach(cat => currentTotal += chemData[cat].length);
        document.getElementById('total-selected-items').innerText = currentTotal;

        const btnQuiz = document.getElementById('btn-start-quiz');
        if (btnQuiz) btnQuiz.disabled = (selectedChapters.size === 0);
    }

    function switchView(view) {
        document.querySelectorAll('.view-section').forEach(sec => sec.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        
        if (view === 'note') {
            document.getElementById('view-note').classList.add('active');
            document.querySelectorAll('.tab-btn')[0].classList.add('active');
        } else {
            document.getElementById('view-quiz').classList.add('active');
            document.querySelectorAll('.tab-btn')[1].classList.add('active');
            // åˆ‡æ›åˆ°æ¸¬é©—æ™‚ï¼Œé‡ç½®é¸å–®é¡¯ç¤ºï¼Œå¼·åˆ¶é‡æ–°ç¹ªè£½ä»¥é˜²è¬ä¸€
            document.getElementById('quiz-menu').style.display = 'block';
            document.getElementById('quiz-play').style.display = 'none';
            document.getElementById('quiz-result').style.display = 'none';
            renderMenu(); 
        }
        window.scrollTo(0, 0);
    }

    // ================= æ¸¬é©—é‚è¼¯ =================

    function prepareQuiz() {
        let total = 0;
        selectedChapters.forEach(cat => total += chemData[cat].length);
        
        document.getElementById('modal-total-items').innerText = total;
        const input = document.getElementById('quiz-num-input');
        input.max = total;
        input.value = Math.min(total, 10); 
        document.getElementById('quiz-settings-modal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('quiz-settings-modal').style.display = 'none';
    }

    function confirmStartQuiz() {
        let allItems = [];
        selectedChapters.forEach(cat => {
            allItems = allItems.concat(chemData[cat]);
        });

        let count = parseInt(document.getElementById('quiz-num-input').value);
        if (isNaN(count) || count < 1) count = 5;
        if (count > allItems.length) count = allItems.length;

        shuffle(allItems);
        currentList = allItems.slice(0, count);

        closeModal();
        startQuizFlow();
    }

    function startQuizFlow() {
        currentIndex = 0;
        score = 0;
        mistakes = [];
        
        document.getElementById('quiz-menu').style.display = 'none';
        document.getElementById('quiz-play').style.display = 'block';
        loadQuestion();
    }

    function loadQuestion() {
        if (currentIndex >= currentList.length) {
            showResult();
            return;
        }

        const q = currentList[currentIndex];
        
        document.getElementById('q-curr').innerText = currentIndex + 1;
        document.getElementById('q-total').innerText = currentList.length;
        document.getElementById('score').innerText = Math.round(score);
        document.getElementById('progress-fill').style.width = `${(currentIndex / currentList.length) * 100}%`;
        
        document.getElementById('feedback').style.display = 'none';
        
        const questionArea = document.getElementById('question-area');
        const answerArea = document.getElementById('answer-area');
        questionArea.innerHTML = '';
        answerArea.innerHTML = '';

        if (q.type === 'fill') {
            // --- å¡«ç©ºé¡Œ ---
            const qCard = document.createElement('div');
            qCard.className = 'question-box';
            qCard.innerHTML = `
                <div style="font-size:1.3rem; line-height:2;">
                    ${q.pre} <div class="drop-slot" id="slot">?</div> ${q.post ? q.post : ''}
                </div>`;
            questionArea.appendChild(qCard);

            answerArea.className = 'drag-pool';
            const opts = [q.ans, ...q.opts].sort(() => 0.5 - Math.random());
            opts.forEach(opt => {
                const btn = document.createElement('div');
                btn.className = 'drag-item';
                btn.innerText = opt;
                btn.onclick = () => checkFillAnswer(opt, q);
                answerArea.appendChild(btn);
            });

        } else {
            // --- é¸æ“‡é¡Œ ---
            const qCard = document.createElement('div');
            qCard.className = 'question-box';
            if (q.type && q.type.includes('image')) {
                qCard.innerHTML = `${q.svg}<div class="q-text" style="font-size:1.2rem; margin-top:15px;">${q.q}</div>`;
            } else {
                qCard.innerHTML = `<div class="q-text">${q.q}</div>`;
            }
            questionArea.appendChild(qCard);

            answerArea.className = 'options-grid';
            const opts = [...q.o].sort(() => 0.5 - Math.random());
            opts.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'opt-btn';
                btn.innerText = opt;
                btn.onclick = () => checkChoiceAnswer(btn, opt, q);
                answerArea.appendChild(btn);
            });
        }
    }

    function checkChoiceAnswer(btn, userAns, qData) {
        const btns = document.querySelectorAll('.opt-btn');
        btns.forEach(b => b.disabled = true);

        if (userAns === qData.a) {
            btn.classList.add('correct');
            score += 100 / currentList.length;
            showFeedback(true, qData.exp);
        } else {
            btn.classList.add('wrong');
            btns.forEach(b => { if(b.innerText === qData.a) b.classList.add('correct'); });
            showFeedback(false, `æ­£è§£æ˜¯ï¼š${qData.a}ã€‚<br>${qData.exp}`);
            mistakes.push(qData);
        }
    }

    function checkFillAnswer(userAns, qData) {
        const slot = document.getElementById('slot');
        if (slot.classList.contains('filled')) return; 

        slot.innerText = userAns;
        slot.classList.add('filled');
        
        const items = document.querySelectorAll('.drag-item');
        items.forEach(i => i.style.pointerEvents = 'none');

        if (userAns === qData.ans) {
            slot.style.borderBottomColor = 'var(--success)';
            slot.style.color = 'var(--success)';
            score += 100 / currentList.length;
            showFeedback(true, qData.exp);
        } else {
            slot.classList.add('error');
            showFeedback(false, `éŒ¯å›‰ï¼æ­£è§£æ˜¯ï¼š${qData.ans}ã€‚<br>${qData.exp}`);
            mistakes.push(qData);
        }
    }

    function showFeedback(isCorrect, text) {
        const fb = document.getElementById('feedback');
        const fbText = document.getElementById('feedback-text');
        fb.style.display = 'block';
        fbText.innerHTML = isCorrect ? `âœ… ç­”å°äº†ï¼<br><small>${text}</small>` : `âŒ ç­”éŒ¯äº†...<br><small>${text}</small>`;
    }

    function nextQuestion() {
        currentIndex++;
        loadQuestion();
    }

    function showResult() {
        document.getElementById('quiz-play').style.display = 'none';
        document.getElementById('quiz-result').style.display = 'block';
        
        document.getElementById('final-score').innerText = Math.round(score);
        const section = document.getElementById('mistake-section');
        const list = document.getElementById('mistake-list');
        list.innerHTML = "";

        if (mistakes.length > 0) {
            section.style.display = 'block';
            mistakes.forEach(m => {
                let displayQ = '', displayA = '';
                if (m.type === 'fill') {
                    displayQ = `${m.pre} ____ ${m.post ? m.post : ''}`; displayA = m.ans;
                } else {
                    displayQ = (m.type && m.type.includes('image')) ? 'çœ‹åœ–é¡Œ' : m.q; displayA = m.a;
                }

                list.innerHTML += `
                    <div class="mistake-card">
                        <div style="font-weight:bold; color:#333;">${displayQ}</div>
                        <div style="color:var(--success); margin-top:5px;">æ­£è§£ï¼š${displayA}</div>
                        <div style="font-size:0.9rem; color:#666; margin-top:5px;">${m.exp}</div>
                    </div>
                `;
            });
        } else {
            section.style.display = 'none';
        }
    }

    function retryQuiz() {
        shuffle(currentList); 
        startQuizFlow();
    }

    function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }

</script>
</body>
</html>
